<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾è¡¨</title>
    <link rel="stylesheet" href="mobile.css">
    <!-- æ·»åŠ å­—ä½“å›¾æ ‡æ”¯æŒ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .timetable-container {
            max-width: 1500px;
            margin: 0;
            padding: 0 5px;
        }
        
        .timetable-wrapper {
            overflow-x: auto;
            width: 100%;
        }
        
        .timetable-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .timetable-header h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
        }
        
        /* æ§åˆ¶åŒºåŸŸå®¹å™¨ - ä½¿å‘¨æ¬¡åˆ‡æ¢å’Œè¯¾è¡¨é€‰æ‹©åœ¨åŒä¸€è¡Œ */
        .timetable-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
        }
        
        /* å‘¨æ¬¡åˆ‡æ¢åŒºåŸŸ - æ”¾åœ¨å·¦ä¾§ */
        .week-selector {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 15px;
            background: rgba(128, 126, 247, 0.1);
            padding: 8px 15px;
            border-radius: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* å‘¨æ¬¡åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .week-selector button {
            background-color: #807ef7;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .week-selector button:hover {
            background-color: #6a67d0;
            transform: scale(1.05);
        }
        
        .week-selector button:active {
            transform: scale(0.95);
        }
        
        /* å½“å‰å‘¨æ•°æ˜¾ç¤ºæ ·å¼ */
        .week-selector #currentWeek {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            min-width: 60px;
            text-align: center;
        }
        
        /* è¯¾è¡¨åˆ‡æ¢åŒºåŸŸ - æ”¾åœ¨å³ä¾§ */
        .timetable-switcher {
            margin-left: auto;
            display: flex;
            align-items: center;
        }
        
        #timetableSelector {
            padding: 8px 12px;
            border: 2px solid #807ef7;
            border-radius: 8px;
            background-color: white;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #timetableSelector:hover {
            background-color: #f0f0ff;
            box-shadow: 0 2px 8px rgba(128, 126, 247, 0.3);
        }
        
        #timetableSelector:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(128, 126, 247, 0.3);
        }
        
        .timetable {
            width: 850px; /* å‡å°å®½åº¦ä½¿è¯¾è¡¨æ›´ç´§å‡‘ */
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
            table-layout: fixed;
        }
        
        .timetable th,
        .timetable td {
            border: 1px solid #e0e0e0;
            padding: 8px; /* å‡å°å†…è¾¹è· */
            text-align: center;
            vertical-align: top;
        }
        
        .timetable th {
            background: #807ef7;
            color: white;
            font-weight: bold;
        }
        
        /* ä¸ºè¡¨æ ¼å¤´éƒ¨æ·»åŠ stickyæ•ˆæœï¼Œä½¿å…¶åœ¨æ»šåŠ¨æ—¶å›ºå®šåœ¨é¡¶éƒ¨ */
        .timetable thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* è°ƒæ•´å‘¨å››åŒºåŸŸä½ç½® */
        .timetable th:nth-child(5),
        .timetable td:nth-child(5) {
            position: relative;
        }
        
        /* è°ƒæ•´è¯¾è¡¨å•å…ƒæ ¼é«˜åº¦å’Œæ ·å¼ */
        .timetable td {
            height: 60px; /* å‡å°å•å…ƒæ ¼é«˜åº¦ */
            width: 12.5%;
            position: relative;
            padding: 3px; /* å‡å°å†…è¾¹è· */
        }
        
        /* å›ºå®šæ¯ä¸ªèŠ‚æ¬¡çš„é«˜åº¦ */
        .timetable tr {
            height: 60px; /* å‡å°è¡Œé«˜ */
        }
        
        /* ä¸ºèŠ‚æ¬¡åˆ—è®¾ç½®è¾ƒå°çš„å®½åº¦ */
        .timetable th:first-child,
        .timetable td:first-child {
            width: 8%;
            height: auto;
        }
        
        /* ç‰¹åˆ«å‡å°‘èŠ‚æ¬¡è¡Œçš„é«˜åº¦ */
        .timetable tbody tr td:first-child {
            height: 30px;
            line-height: 30px;
        }
        
        /* è°ƒæ•´è¯¾ç¨‹å¡ç‰‡æ ·å¼ - ç¡®ä¿å¡«å……æ•´ä¸ªå•å…ƒæ ¼ */
        .course {
            background: #f0f0ff;
            border-radius: 4px; /* ç¨å¾®å‡å°åœ†è§’ */
            padding: 6px; /* å‡å°å†…è¾¹è· */
            margin: 2px 0; /* é€‚å½“å¢åŠ å¤–è¾¹è· */
            font-size: 13px; /* å¢å¤§å­—ä½“ */
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 46px; /* å‡å°æœ€å°é«˜åº¦ */
            height: 100%; /* å¡«å……çˆ¶å®¹å™¨ */
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        
        /* åˆå¹¶è¯¾ç¨‹çš„ç‰¹æ®Šæ ·å¼ */
        .course.merged {
            min-height: 100px; /* è°ƒæ•´åˆå¹¶è¯¾ç¨‹çš„æœ€å°é«˜åº¦ */
            height: 124px; /* è°ƒæ•´åˆå¹¶è¯¾ç¨‹çš„é«˜åº¦ */
        }
        
        .course:hover {
            background: #e0e0ff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* ä¼˜åŒ–è¯¾ç¨‹æ ‡é¢˜æ˜¾ç¤º */
        .course-title-container {
            flex-shrink: 0;
            margin-bottom: 6px; /* å¢åŠ åº•éƒ¨é—´è· */
            padding-bottom: 4px; /* å¢åŠ åº•éƒ¨å†…è¾¹è· */
            border-bottom: 1px solid rgba(128, 126, 247, 0.2); /* æ·»åŠ åˆ†éš”çº¿ */
        }
        
        .course-title {
            font-weight: bold;
            color: #333;
            font-size: 14px; /* å¢å¤§æ ‡é¢˜å­—ä½“ */
            line-height: 1.3; /* è°ƒæ•´è¡Œé«˜ */
            max-height: 2.6em; /* é™åˆ¶æœ€å¤šæ˜¾ç¤ºä¸¤è¡Œ */
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .course-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* å°†å†…å®¹æ”¾ç½®åœ¨åº•éƒ¨ */
            margin-top: auto; /* è‡ªåŠ¨è°ƒæ•´é¡¶éƒ¨é—´è· */
        }
        
        .course-info {
            color: #666;
            font-size: 12px; /* å¢å¤§å­—ä½“ */
            margin-bottom: 2px; /* å‡å°åº•éƒ¨é—´è· */
        }
        
        .course-period-container {
            display: flex;
            align-items: center;
            flex-grow: 1;
            min-height: 18px; /* è®¾ç½®æœ€å°é«˜åº¦ */
        }
        
        .course-period {
            color: #888;
            font-size: 13px; /* å¢å¤§å­—ä½“ */
            margin-top: 2px; /* å‡å°é¡¶éƒ¨é—´è· */
        }
        
        .course-weeks {
            color: #888;
            font-size: 11px; /* å¢å¤§å­—ä½“ */
            margin-top: 2px; /* å‡å°é¡¶éƒ¨é—´è· */
        }
        
        .no-course {
            color: #ccc;
            font-size: 12px; /* å¢å¤§å­—ä½“ */
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        /* ç§»é™¤åŸæœ‰çš„å“åº”å¼è°ƒæ•´ï¼Œä¿æŒå›ºå®šæ ·å¼ */
        @media (max-width: 768px) {
            .timetable th,
            .timetable td {
                padding: 12px;
                font-size: 14px;
                height: 80px;
            }
            
            .course {
                padding: 5px;
                font-size: 13px;
                min-height: 42px;
            }
            
            .course-info,
            .course-period,
            .course-weeks {
                font-size: 12px;
            }
            
            .week-selector {
                flex-direction: row;
                gap: 15px;
            }
            
            .course-period-container {
                display: flex;
                align-items: center;
                flex-grow: 1;
                min-height: 16px;
            }
            
            .course-period {
                font-size: 12px;
            }
        }
        
        /* å½“å±å¹•å®½åº¦å°äº450pxæ—¶ï¼Œä¿æŒå›ºå®šæ ·å¼ */
        @media (max-width: 450px) {
            .timetable th,
            .timetable td {
                height: 80px;
                padding: 12px;
            }
            
            .course {
                padding: 5px;
                font-size: 13px;
                min-height: 42px;
            }
            
            .course-title {
                font-size: 14px;
            }
            
            .course-info,
            .course-period,
            .course-weeks {
                font-size: 12px;
            }
            
            .course-period-container {
                display: flex;
                align-items: center;
                flex-grow: 1;
                min-height: 16px;
            }
            
            .course-period {
                font-size: 12px;
            }
            
            .weekday {
                font-size: 14px;
            }
        }
        
        /* å¤´éƒ¨åŒºåŸŸå±…ä¸­æ ·å¼ */
        .search-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .menu-button {
            position: absolute;
            left: 0;
        }
        
        .header-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* æ»‘åŠ¨å¼€å…³æ ·å¼ */
        .toggle-container {
            position: absolute;
            right: 0;
            display: flex;
            align-items: center;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
            box-sizing: border-box;
        }
        
        .slider-text {
            font-size: 12px;
            font-weight: bold;
            z-index: 1;
            transition: opacity 0.4s;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .slider-text.left {
            left: 8px;
            opacity: 0;
            color: white;
        }
        
        .slider-text.right {
            right: 8px;
            opacity: 1;
            color: #333;
        }
        
        input:checked + .slider .slider-text.left {
            opacity: 1;
        }
        
        input:checked + .slider .slider-text.right {
            opacity: 0;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            z-index: 2;
        }
        
        input:checked + .slider {
            background-color: #807ef7;
        }
        
        input:checked + .slider:before {
            transform: translateX(32px);
        }
        
        input:checked + .slider .slider-text.left {
            color: white;
        }
        
        input:checked + .slider .slider-text.right {
            color: #333;
        }
        
        /* å½“å±å¹•å®½åº¦å°äº450pxæ—¶ï¼Œå°†æ˜ŸæœŸæ ‡é¢˜ç®€åŒ–ä¸ºå•ä¸ªå­— */
        @media (max-width: 450px) {
            .weekday {
                font-size: 12px;
            }
        }
        
        /* å®æ—¶è¯¾ç¨‹ä¿¡æ¯å®¹å™¨æ ·å¼ */
        .realtime-cards-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 12px;
            /* box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); */
            /* border: 1px solid #e9ecef; */
            margin: 20px auto;
            max-width: 1400px; /* å¢åŠ æœ€å¤§å®½åº¦ */
        }
        
        .realtime-card {
            display: flex;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }
        
        .realtime-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .realtime-card-header {
            flex: 0 0 120px;
            background-color: #e9ecef;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            color: #495057;
            border-right: 1px solid #dee2e6;
        }
        
        .realtime-card-content {
            flex: 1;
            display: flex;
        }
        
        .realtime-card-section {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            text-align: center;
        }
        
        .realtime-card-section:not(:last-child) {
            border-right: 1px solid #e9ecef;
        }
        
        .realtime-card-section h3 {
            margin: 0 0 15px 0;
            font-size: 1.1em;
            color: #495057;
        }
        
        .course-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #212529;
        }
        
        .course-time, .course-classroom {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 3px;
        }
        
        .no-course {
            color: #6c757d;
            font-style: italic;
        }
        
        /* å“åº”å¼è®¾è®¡ - ä¿æŒæ¨ªå‘å¸ƒå±€ */
        @media (max-width: 768px) {
            .realtime-cards-container {
                padding: 15px;
                margin: 15px;
                border-radius: 8px;
            }
            
            .realtime-card {
                border-radius: 8px;
            }
            
            .realtime-card-header {
                flex: 0 0 100px;
                padding: 15px;
                font-size: 1.1em;
            }
            
            .realtime-card-section {
                padding: 15px;
            }
            
            .realtime-card-section h3 {
                font-size: 1em;
                margin-bottom: 10px;
            }
            
            .course-title {
                font-size: 1em;
            }
            
            .course-time, .course-classroom {
                font-size: 0.85em;
            }
        }
        
        @media (max-width: 480px) {
            .realtime-cards-container {
                padding: 10px;
                margin: 10px;
            }
            
            .realtime-card-header {
                flex: 0 0 80px;
                padding: 10px;
                font-size: 1em;
            }
            
            .realtime-card-section {
                padding: 10px;
            }
            
            .realtime-card-section h3 {
                font-size: 0.9em;
                margin-bottom: 8px;
            }
            
            .course-title {
                font-size: 0.9em;
            }
            
            .course-time, .course-classroom {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="search-container">
            <button id="homeButton" class="menu-button" onclick="window.location.href='index.html'">
                <i class="fas fa-home"></i>
            </button>
            <div class="header-info">
                <h1 id="currentDateTime" style="margin: 0; font-size: 18px; text-align: center; color: black;"></h1>
                <div id="currentWeekDisplay" style="text-align: center; font-size: 16px; color: black; margin-top: 5px;"></div>
            </div>
            <!-- æ»‘åŠ¨å¼€å…³ -->
            <div class="toggle-container">
                <label class="switch integrated">
                    <input type="checkbox" id="controlsToggle">
                    <span class="slider">
                        <span class="slider-text left">æ€»è§ˆ</span>
                        <span class="slider-text right">å®æ—¶</span>
                    </span>
                </label>
            </div>
        </div>
    </header>

    <main>
        <div class="timetable-container">
            <div class="timetable-controls">
                <div class="week-selector">
                    <button id="prevWeek"><i class="fas fa-arrow-left"></i></button>
                    <span id="currentWeek">ç¬¬1å‘¨</span>
                    <button id="nextWeek"><i class="fas fa-arrow-right"></i></button>
                </div>
                <div class="timetable-switcher">
                    <select id="timetableSelector">
                        <option value="huxinyue.txt" selected>H</option>
                        <option value="X.txt">X</option>
                        <option value="yangxin.txt">Y</option>
                    </select>
                </div>
            </div>
            
            <!-- å®æ—¶è¯¾ç¨‹ä¿¡æ¯å®¹å™¨ -->
            <div id="realtime-container" class="realtime-container">
                <div class="realtime-cards-container">
                    <!-- Hç”¨æˆ·å¡ç‰‡ -->
                    <div class="realtime-card">
                        <div class="realtime-card-header">
                            <h3>H</h3>
                        </div>
                        <div class="realtime-card-content">
                            <div class="realtime-card-section">
                                <div class="realtime-card-section-title">å½“å‰è¯¾ç¨‹</div>
                                <div id="current-H" class="realtime-card-section-content">åŠ è½½ä¸­...</div>
                            </div>
                            <div class="realtime-card-section">
                                <div class="realtime-card-section-title">ä¸‹ä¸€è¯¾ç¨‹</div>
                                <div id="next-H" class="realtime-card-section-content">åŠ è½½ä¸­...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Xç”¨æˆ·å¡ç‰‡ -->
                    <div class="realtime-card">
                        <div class="realtime-card-header">
                            <h3>X</h3>
                        </div>
                        <div class="realtime-card-content">
                            <div class="realtime-card-section">
                                <div class="realtime-card-section-title">å½“å‰è¯¾ç¨‹</div>
                                <div id="current-X" class="realtime-card-section-content">åŠ è½½ä¸­...</div>
                            </div>
                            <div class="realtime-card-section">
                                <div class="realtime-card-section-title">ä¸‹ä¸€è¯¾ç¨‹</div>
                                <div id="next-X" class="realtime-card-section-content">åŠ è½½ä¸­...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Yç”¨æˆ·å¡ç‰‡ -->
                    <div class="realtime-card">
                        <div class="realtime-card-header">
                            <h3>Y</h3>
                        </div>
                        <div class="realtime-card-content">
                            <div class="realtime-card-section">
                                <div class="realtime-card-section-title">å½“å‰è¯¾ç¨‹</div>
                                <div id="current-Y" class="realtime-card-section-content">åŠ è½½ä¸­...</div>
                            </div>
                            <div class="realtime-card-section">
                                <div class="realtime-card-section-title">ä¸‹ä¸€è¯¾ç¨‹</div>
                                <div id="next-Y" class="realtime-card-section-content">åŠ è½½ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="timetable-wrapper">
                <table class="timetable" id="timetable">
                    <thead>
                        <tr>
                            <th>èŠ‚æ¬¡</th>
                            <th class="weekday" data-full="æ˜ŸæœŸä¸€">ä¸€</th>
                            <th class="weekday" data-full="æ˜ŸæœŸäºŒ">äºŒ</th>
                            <th class="weekday" data-full="æ˜ŸæœŸä¸‰">ä¸‰</th>
                            <th class="weekday" data-full="æ˜ŸæœŸå››">å››</th>
                            <th class="weekday" data-full="æ˜ŸæœŸäº”">äº”</th>
                            <th class="weekday" data-full="æ˜ŸæœŸå…­">å…­</th>
                            <th class="weekday" data-full="æ˜ŸæœŸæ—¥">æ—¥</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- è¯¾è¡¨å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- æ¨¡æ€æ¡†å®¹å™¨ -->
    <div id="modal-container" class="modal-container">
        <!-- è¯¾ç¨‹è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div id="course-detail-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>è¯¾ç¨‹è¯¦æƒ…</h2>
                    <span class="modal-close">&times;</span>
                </div>
                <div class="modal-body" id="course-detail-body">
                    <!-- è¯¾ç¨‹è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toastæç¤ºå®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <script>
        // å½“å‰å‘¨æ•°
        let currentWeek = 1;
        const maxWeek = 16;
        
        // è¯¾è¡¨æ•°æ®ï¼ˆæŒ‰ç”¨æˆ·å’Œå‘¨æ¬¡å­˜å‚¨ï¼‰
        let timetableData = {
            'H': {},
            'X': {},
            'Y': {}
        };
        
        // å½“å‰é€‰ä¸­çš„ç”¨æˆ·
        let currentSelectedUser = 'H';
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä¸ºæ‰€æœ‰ç”¨æˆ·åŠ è½½è¯¾è¡¨æ•°æ®
            loadTimetableData('huxinyue.txt', 'H');
            loadTimetableData('X.txt', 'X');
            loadTimetableData('yangxin.txt', 'Y');
            
            // è‡ªåŠ¨è·³è½¬åˆ°å½“å‰å‘¨æ¬¡
            currentWeek = calculateCurrentWeek();
            setupEventListeners();
            // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
            setInterval(updateDateTime, 60000);
        });
        
        // åŠ è½½è¯¾è¡¨æ•°æ®
        function loadTimetableData(filename = 'huxinyue.txt', user = null) {
            // å¦‚æœæ²¡æœ‰æŒ‡å®šç”¨æˆ·ï¼Œåˆ™æ ¹æ®æ–‡ä»¶åç¡®å®šç”¨æˆ·
            if (!user) {
                if (filename === 'huxinyue.txt') user = 'H';
                else if (filename === 'X.txt') user = 'X';
                else if (filename === 'yangxin.txt') user = 'Y';
                else user = currentSelectedUser; // é»˜è®¤ä½¿ç”¨å½“å‰é€‰ä¸­çš„ç”¨æˆ·
            }
            
            fetch(`./timetable/${filename}`)
                .then(response => response.text())
                .then(data => {
                    parseTimetableData(data, user);
                    renderTimetable();
                    // æ•°æ®åŠ è½½å®Œæˆåæ›´æ–°å®æ—¶è¯¾ç¨‹ä¿¡æ¯
                    updateDateTime();
                })
                .catch(error => {
                    console.error('åŠ è½½è¯¾è¡¨æ•°æ®å¤±è´¥:', error);
                    showToast('åŠ è½½è¯¾è¡¨æ•°æ®å¤±è´¥');
                });
        }
        
        // è§£æè¯¾è¡¨æ•°æ®
        function parseTimetableData(textData, user = currentSelectedUser) {
            // åˆå§‹åŒ–è¯¾è¡¨æ•°æ®ç»“æ„ï¼ˆæŒ‰å‘¨æ¬¡å­˜å‚¨ï¼‰
            timetableData[user] = {};
            
            // ä¸ºæ¯ä¸€å‘¨åˆå§‹åŒ–è¯¾è¡¨æ•°æ®ç»“æ„
            for (let week = 1; week <= 16; week++) {
                timetableData[user][week] = Array(10).fill().map(() => Array(7).fill(null));
            }
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            
            // æŒ‰æ˜ŸæœŸåˆ†å‰²æ•°æ®ï¼Œä½¿ç”¨å¼€å§‹æ ‡ç­¾ä½œä¸ºåˆ†å‰²ç‚¹
            // ä¿®æ”¹åˆ†å‰²é€»è¾‘ï¼Œæ­£ç¡®å¤„ç†æ•°æ®æ ¼å¼
            const daySections = textData.split(/\r?\n\r?\n/).filter(section => section.trim() !== '' && section.includes('[æ˜ŸæœŸ'));
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            
            // éå†æ¯ä¸ªæ˜ŸæœŸçš„æ•°æ®
            for (let idx = 0; idx < daySections.length; idx++) {
                const daySection = daySections[idx];
                // è·å–æ˜ŸæœŸä¿¡æ¯
                const dayLines = daySection.trim().split(/\r?\n/);
                const dayHeader = dayLines[0];
                
                // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                
                // ç¡®å®šæ˜ŸæœŸå‡ ï¼ˆ0-6ï¼Œæ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸæ—¥ï¼‰
                let day = -1;
                if (dayHeader.includes('[æ˜ŸæœŸä¸€]')) day = 0;
                else if (dayHeader.includes('[æ˜ŸæœŸäºŒ]')) day = 1;
                else if (dayHeader.includes('[æ˜ŸæœŸä¸‰]')) day = 2;
                else if (dayHeader.includes('[æ˜ŸæœŸå››]')) day = 3;
                else if (dayHeader.includes('[æ˜ŸæœŸäº”]')) day = 4;
                else if (dayHeader.includes('[æ˜ŸæœŸå…­]')) day = 5;
                else if (dayHeader.includes('[æ˜ŸæœŸæ—¥]')) day = 6;
                
                // æ·»åŠ è°ƒè¯•ä¿¡æ¯

                // å¦‚æœæ˜¯æ˜ŸæœŸæ—¥ä¸”å†…å®¹ä¸º"(æ— è¯¾ç¨‹å®‰æ’)"ï¼Œåˆ™è·³è¿‡
                if (day === 6 && dayLines[1] && dayLines[1].includes('(æ— è¯¾ç¨‹å®‰æ’)')) {
                    continue;
                }
                
                // å°†ä¸€å¤©çš„è¯¾ç¨‹ä¿¡æ¯æŒ‰!åˆ†å‰²æˆå¤šä¸ªè¯¾ç¨‹
                const courseSections = daySection.split('!');
                
                // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                
                // è§£ææ¯ä¸ªè¯¾ç¨‹ä¿¡æ¯
                for (let i = 0; i < courseSections.length; i++) {
                    const courseSection = courseSections[i];
                    const courseLines = courseSection.trim().split(/\r?\n/);
                    
                    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                    
                    // è·³è¿‡ç©ºçš„è¯¾ç¨‹éƒ¨åˆ†æˆ–åªæœ‰æ˜ŸæœŸæ ‡é¢˜çš„éƒ¨åˆ†
                    if (courseLines.length <= 1) {
                        continue;
                    }
                    
                    // ç¡®å®šè¯¾ç¨‹å¼€å§‹çš„è¡Œå·
                    let startLine = 0;
                    if (courseLines[0].includes('[æ˜ŸæœŸ')) {
                        startLine = 1;
                    }
                    
                    // ç¡®ä¿æœ‰è¶³å¤Ÿçš„è¡Œæ¥è§£æè¯¾ç¨‹ä¿¡æ¯
                    if (startLine + 3 >= courseLines.length) {
                        continue;
                    }
                    
                    // è§£æè¯¾ç¨‹ä¿¡æ¯
                    const course = {};
                    
                    // è§£æè¯¾ç¨‹ä¿¡æ¯
                    if (courseLines[startLine].startsWith('è¯¾ç¨‹:')) {
                        course.title = courseLines[startLine].replace('è¯¾ç¨‹:', '').trim();
                    }
                    if (startLine + 1 < courseLines.length && courseLines[startLine + 1].startsWith('æ•™å®¤:')) {
                        course.classroom = courseLines[startLine + 1].replace('æ•™å®¤:', '').trim();
                    }
                    if (startLine + 2 < courseLines.length && courseLines[startLine + 2].startsWith('èŠ‚æ¬¡:')) {
                        course.period = courseLines[startLine + 2].replace('èŠ‚æ¬¡:', '').trim();
                    }
                    if (startLine + 3 < courseLines.length && courseLines[startLine + 3].startsWith('å‘¨æ¬¡:')) {
                        course.weeks = courseLines[startLine + 3].replace('å‘¨æ¬¡:', '').trim();
                    }
                    
                    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                    
                    // æ£€æŸ¥è¯¾ç¨‹ä¿¡æ¯æ˜¯å¦å®Œæ•´
                    if (!course.title || !course.classroom || !course.period || !course.weeks) {
                        continue;
                    }
                    
                    // è§£æå‘¨æ¬¡ä¿¡æ¯
                    if (course.weeks) {
                        const weekMatch = course.weeks.match(/ç¬¬(\d+)-(\d+)å‘¨/);
                        if (weekMatch) {
                            const startWeek = parseInt(weekMatch[1]);
                            const endWeek = parseInt(weekMatch[2]);
                            
                            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                            
                            // è§£æèŠ‚æ¬¡ä¿¡æ¯ï¼Œç¡®å®šè¯¾ç¨‹åœ¨è¯¾è¡¨ä¸­çš„ä½ç½®
                            if (course.period) {
                                const periodMatch = course.period.match(/(\d+)(?:-(\d+))?/);
                                if (periodMatch) {
                                    const startPeriod = parseInt(periodMatch[1]);
                                    const endPeriod = periodMatch[2] ? parseInt(periodMatch[2]) : startPeriod;
                                    
                                    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                                    
                                    // æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
                                    if (startWeek >= 1 && endWeek <= 16 && startPeriod >= 1 && endPeriod <= 10 && day >= 0 && day < 7) {
                                        // ä¸ºæ¯ä¸ªå‘¨æ¬¡å­˜å‚¨è¯¾ç¨‹ä¿¡æ¯
                                        for (let week = startWeek; week <= endWeek; week++) {
                                            // åœ¨è¯¾è¡¨æ•°æ®ä¸­è®¾ç½®è¯¾ç¨‹ä¿¡æ¯
                                            for (let period = startPeriod; period <= endPeriod; period++) {
                                                if (day >= 0 && day < 7 && period >= 1 && period <= 10) {
                                                    timetableData[user][week][period - 1][day] = {
                                                        title: course.title,
                                                        classroom: course.classroom,
                                                        period: course.period,
                                                        weeks: course.weeks
                                                    };
                                                    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                                                }
                                            }
                                        }
                                    } else {
                        }
                                } else {
                                  }
                              }
                          } else {
                          }
                    }
                }
            }
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼ŒæŸ¥çœ‹è§£æåçš„æ•°æ®
            
            // æ£€æŸ¥ç¬¬ä¸€å‘¨çš„æ•°æ®
        }
        
        // æ¸²æŸ“è¯¾è¡¨
        function renderTimetable() {
            const tbody = document.querySelector('#timetable tbody');
            tbody.innerHTML = '';
            
            // æ›´æ–°å½“å‰å‘¨æ•°æ˜¾ç¤º
            document.getElementById('currentWeek').textContent = `ç¬¬${currentWeek}å‘¨`;
            
            // è·å–å½“å‰é€‰ä¸­ç”¨æˆ·å’Œå‘¨æ¬¡çš„è¯¾è¡¨æ•°æ®
            const weekData = timetableData[currentSelectedUser] && timetableData[currentSelectedUser][currentWeek] || Array(10).fill().map(() => Array(7).fill(null));
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            
            // ç”¨äºè®°å½•å·²ç»å¤„ç†è¿‡çš„è¯¾ç¨‹å•å…ƒæ ¼ï¼Œé¿å…é‡å¤æ¸²æŸ“
            const processedCells = Array(10).fill().map(() => Array(7).fill(false));
            
            // ç”Ÿæˆè¯¾è¡¨è¡Œï¼ˆå‡è®¾æœ€å¤š10èŠ‚è¯¾ï¼‰
            for (let period = 1; period <= 10; period++) {
                const row = document.createElement('tr');
                
                // æ·»åŠ èŠ‚æ¬¡åˆ—ï¼ˆå§‹ç»ˆæ˜¾ç¤ºèŠ‚æ¬¡ç¼–å·ï¼‰
                const periodCell = document.createElement('td');
                periodCell.textContent = `${period}`;
                row.appendChild(periodCell);
                
                // æ·»åŠ æ¯å¤©çš„è¯¾ç¨‹
                for (let day = 0; day < 7; day++) {
                    // å¦‚æœå½“å‰å•å…ƒæ ¼å·²ç»è¢«å¤„ç†è¿‡ï¼ˆä½œä¸ºèåˆè¯¾ç¨‹çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œåˆ™è·³è¿‡
                    if (processedCells[period - 1][day]) {
                        continue;
                    }
                    
                    const cell = document.createElement('td');
                    
                    // æŸ¥æ‰¾è¯¥èŠ‚æ¬¡è¯¥å¤©çš„è¯¾ç¨‹
                    const course = weekData[period - 1][day];
                    
                    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                    if (course) {
                    }
                    
                    if (course) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰è¿ç»­çš„ç›¸åŒè¯¾ç¨‹ï¼ˆç”¨äºèåˆæ˜¾ç¤ºï¼‰
                        let isMerged = false;
                        let mergeCount = 1; // èåˆçš„è¯¾ç¨‹èŠ‚æ•°
                        
                        // æ£€æŸ¥å½“å‰è¯¾ç¨‹çš„èŠ‚æ¬¡èŒƒå›´
                        const currentPeriodMatch = course.period.match(/(\d+)(?:-(\d+))?/);
                        let currentStartPeriod = period;
                        let currentEndPeriod = period;
                        if (currentPeriodMatch) {
                            currentStartPeriod = parseInt(currentPeriodMatch[1]);
                            currentEndPeriod = currentPeriodMatch[2] ? parseInt(currentPeriodMatch[2]) : currentStartPeriod;
                        }
                        
                        // å®šä¹‰éœ€è¦ç‰¹æ®Šå¤„ç†çš„èŠ‚æ¬¡ç»„åˆ
                        const specialCombinations = [
                            [1, 3], [1, 4], [2, 4],  // ä¸Šåˆæ—¶æ®µ
                            [5, 7], [5, 8], [6, 8]   // ä¸‹åˆæ—¶æ®µ
                        ];
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ¹é…ç‰¹æ®ŠèŠ‚æ¬¡ç»„åˆ
                        let isSpecialCombination = false;
                        for (const combo of specialCombinations) {
                            if (currentStartPeriod === combo[0] && currentEndPeriod === combo[1]) {
                                isSpecialCombination = true;
                                mergeCount = combo[1] - combo[0] + 1;
                                break;
                            }
                        }
                        
                        // å¦‚æœä¸æ˜¯ç‰¹æ®Šç»„åˆï¼Œä½¿ç”¨åŸæœ‰çš„æ—¶æ®µåˆ†ç»„é€»è¾‘
                        if (!isSpecialCombination) {
                            // ä¸Šåˆæ—¶æ®µï¼š1-4èŠ‚ï¼Œä¸‹åˆæ—¶æ®µï¼š5-8èŠ‚ï¼Œæ™šä¸Šæ—¶æ®µï¼š9-10èŠ‚
                            let maxPeriodInSession = 10;
                            if (period <= 4) {
                                maxPeriodInSession = 4; // ä¸Šåˆæ—¶æ®µ
                            } else if (period <= 8) {
                                maxPeriodInSession = 8; // ä¸‹åˆæ—¶æ®µ
                            } else {
                                maxPeriodInSession = 10; // æ™šä¸Šæ—¶æ®µ
                            }
                            
                            // è®¡ç®—å®é™…åº”è¯¥èåˆçš„è¯¾ç¨‹èŠ‚æ•°
                            let actualEndPeriod = Math.min(currentEndPeriod, maxPeriodInSession);
                            mergeCount = actualEndPeriod - period + 1;
                        }
                        
                        // æ£€æŸ¥æ¥ä¸‹æ¥çš„è¯¾ç¨‹æ˜¯å¦ä¸å½“å‰è¯¾ç¨‹ç›¸åŒ
                        let canMerge = true;
                        for (let i = 1; i < mergeCount; i++) {
                            if (period + i - 1 < 10) {
                                const nextCourse = weekData[period + i - 1][day];
                                if (!nextCourse || 
                                    nextCourse.title !== course.title || 
                                    nextCourse.classroom !== course.classroom ||
                                    nextCourse.weeks !== course.weeks) {
                                    canMerge = false;
                                    // å¯¹äºç‰¹æ®Šç»„åˆï¼Œå¦‚æœä¸èƒ½å®Œå…¨åŒ¹é…åˆ™ä¸èåˆ
                                    if (isSpecialCombination) {
                                        mergeCount = 1;
                                        canMerge = false;
                                        break;
                                    }
                                    mergeCount = i; // æ›´æ–°å®é™…èåˆèŠ‚æ•°
                                    break;
                                }
                            } else {
                                canMerge = false;
                                // å¯¹äºç‰¹æ®Šç»„åˆï¼Œå¦‚æœä¸èƒ½å®Œå…¨åŒ¹é…åˆ™ä¸èåˆ
                                if (isSpecialCombination) {
                                    mergeCount = 1;
                                    canMerge = false;
                                    break;
                                }
                                mergeCount = i; // æ›´æ–°å®é™…èåˆèŠ‚æ•°
                                break;
                            }
                        }
                        
                        // åªæœ‰å½“å¯ä»¥èåˆä¸”èåˆèŠ‚æ•°å¤§äº1æ—¶æ‰è¿›è¡Œèåˆ
                        if (canMerge && mergeCount > 1) {
                            isMerged = true;
                            // æ ‡è®°å·²å¤„ç†çš„èŠ‚æ¬¡
                            for (let i = 1; i < mergeCount; i++) {
                                if (period + i - 1 < 10) {
                                    processedCells[period + i - 1][day] = true;
                                }
                            }
                        }
                        
                        const courseDiv = document.createElement('div');
                        courseDiv.className = 'course';
                        
                        if (isMerged) {
                            // èåˆæ˜¾ç¤ºå¤šèŠ‚è¯¾ç¨‹
                            courseDiv.innerHTML = `
                                <div class="course-title-container">
                                    <div class="course-title">${course.title}</div>
                                </div>
                                <div class="course-details">
                                    <div class="course-info">${course.classroom}</div>
                                    <div class="course-period-container">
                                        <div class="course-period">${period}-${period + mergeCount - 1}</div>
                                    </div>
                                    <div class="course-weeks">${course.weeks}</div>
                                </div>
                            `;
                            courseDiv.classList.add('merged'); // æ·»åŠ mergedç±»
                            // è®¾ç½®rowSpanä¸ºèåˆçš„è¯¾ç¨‹èŠ‚æ•°
                            cell.rowSpan = mergeCount;
                        } else {
                            // æ­£å¸¸æ˜¾ç¤ºå•èŠ‚è¯¾ç¨‹
                            courseDiv.innerHTML = `
                                <div class="course-title-container">
                                    <div class="course-title">${course.title}</div>
                                </div>
                                <div class="course-details">
                                    <div class="course-info">${course.classroom}</div>
                                    <div class="course-period-container">
                                        <div class="course-period">${course.period}</div>
                                    </div>
                                    <div class="course-weeks">${course.weeks}</div>
                                </div>
                            `;
                        }
                        
                        cell.appendChild(courseDiv);
                    } else {
                        cell.innerHTML = '';
                    }
                    
                    row.appendChild(cell);
                }
                
                tbody.appendChild(row);
            }
        }
        
        
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å‘¨æ•°åˆ‡æ¢æŒ‰é’®
            document.getElementById('prevWeek').addEventListener('click', function() {
                if (currentWeek > 1) {
                    currentWeek--;
                    renderTimetable();
                }
            });
            
            document.getElementById('nextWeek').addEventListener('click', function() {
                if (currentWeek < maxWeek) {
                    currentWeek++;
                    renderTimetable();
                }
            });
            
            // è¯¾è¡¨åˆ‡æ¢ä¸‹æ‹‰èœå•
            document.getElementById('timetableSelector').addEventListener('change', function() {
                const selectedTimetable = this.value;
                // æ›´æ–°å½“å‰é€‰ä¸­çš„ç”¨æˆ·
                if (selectedTimetable === 'huxinyue.txt') currentSelectedUser = 'H';
                else if (selectedTimetable === 'X.txt') currentSelectedUser = 'X';
                else if (selectedTimetable === 'yangxin.txt') currentSelectedUser = 'Y';
                
                loadTimetableData(selectedTimetable);
                // è‡ªåŠ¨åˆ‡æ¢åˆ°å½“å‰å‘¨æ¬¡
                currentWeek = calculateCurrentWeek();
                renderTimetable();
            });
            
            // æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
            const closeButtons = document.querySelectorAll('.modal-close');
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    modal.classList.remove('active');
                    document.getElementById('modal-container').style.display = 'none';
                    document.body.style.overflow = '';
                });
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        document.getElementById('modal-container').style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });
            });
            // æ»‘åŠ¨å¼€å…³æ§åˆ¶.timetable-controlsæ˜¾ç¤ºä¸éšè—
            const controlsToggle = document.getElementById('controlsToggle');
            const timetableControls = document.querySelector('.timetable-controls');
            const timetable = document.getElementById('timetable');
            
            // è®¾ç½®é»˜è®¤çŠ¶æ€ä¸ºå®æ—¶æ¨¡å¼ï¼ˆæœªé€‰ä¸­ï¼‰
            controlsToggle.checked = false;
            
            // é¡µé¢åŠ è½½æ—¶æ ¹æ®å¼€å…³çŠ¶æ€è®¾ç½®.timetable-controlså’Œè¯¾è¡¨çš„æ˜¾ç¤ºçŠ¶æ€
            timetableControls.style.display = controlsToggle.checked ? 'flex' : 'none';
            timetable.style.display = controlsToggle.checked ? 'table' : 'none';
            
            // è·å–å®æ—¶ä¿¡æ¯å®¹å™¨
            const realtimeContainer = document.getElementById('realtime-container');
            // æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºå®æ—¶ä¿¡æ¯å®¹å™¨
            realtimeContainer.style.display = controlsToggle.checked ? 'none' : 'block';
            
            controlsToggle.addEventListener('change', function() {
                timetableControls.style.display = this.checked ? 'flex' : 'none';
                timetable.style.display = this.checked ? 'table' : 'none';
                // è·å–å®æ—¶ä¿¡æ¯å®¹å™¨
                const realtimeContainer = document.getElementById('realtime-container');
                // æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºå®æ—¶ä¿¡æ¯å®¹å™¨
                realtimeContainer.style.display = this.checked ? 'none' : 'block';
                
                // åˆ‡æ¢é¡µé¢æ—¶æ›´æ–°å®æ—¶è¯¾ç¨‹ä¿¡æ¯
                updateDateTime();
            });
        }
        
        // æ˜¾ç¤ºToastæç¤º
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            // 3ç§’åç§»é™¤
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // æ›´æ–°é€šçŸ¥æ¨¡æ€æ¡†å†…å®¹ï¼ˆä»mobile.jså¤åˆ¶ï¼‰
        function updateNotificationsModal() {
            const notificationsModal = document.getElementById('about-modal');
            const modalBody = notificationsModal.querySelector('.modal-body');
            
            // ä»fetchè·å–é€šçŸ¥æ•°æ®
            fetch('notification.json')
                .then(response => response.json())
                .then(data => {
                    const notifications = data.notifications || [];
                    
                    if (notifications.length === 0) {
                        modalBody.innerHTML = '<p>æš‚æ— é€šçŸ¥</p>';
                        return;
                    }
                    
                    // æŒ‰ç½®é¡¶çŠ¶æ€æ’åºï¼Œç½®é¡¶çš„é€šçŸ¥æ˜¾ç¤ºåœ¨å‰é¢
                    const pinnedNotifications = notifications.filter(n => n.pinned);
                    const unpinnedNotifications = notifications.filter(n => !n.pinned);
                    const sortedNotifications = [...pinnedNotifications, ...unpinnedNotifications];
                    
                    // æ„å»ºé€šçŸ¥åˆ—è¡¨HTML
                    let notificationsHTML = '<div class="notifications-list">';
                    sortedNotifications.forEach(notification => {
                        // å¤„ç†æ—¶é—´æ˜¾ç¤º
                        const timeStr = notification.time || '';
                        
                        // å¤„ç†å†…å®¹æ˜¾ç¤ºï¼Œé™åˆ¶æ˜¾ç¤ºä¸¤è¡Œ
                        let contentStr = notification.content || '';
                        let contentHTML = '';
                        
                        // åªæ˜¾ç¤ºé¢„è§ˆå†…å®¹ï¼Œç§»é™¤å±•å¼€æŒ‰é’®
                        contentHTML = `<div class="content-preview">${contentStr}</div>`;
                        
                        // å¤„ç†é“¾æ¥æ˜¾ç¤º
                        let linkHTML = '';
                        if (notification.link) {
                            linkHTML = `<div class="notification-link"><a href="javascript:void(0);" class="view-detail-link" data-notification-id="${notification.id}">æŸ¥çœ‹è¯¦æƒ…</a></div>`;
                        }
                        
                        // å¤„ç†é™„ä»¶æ˜¾ç¤º
                        let attachmentHTML = '';
                        if (notification.attachment) {
                            attachmentHTML = `<div class="notification-attachment">é™„ä»¶: ${notification.attachment}</div>`;
                        }
                        
                        // ç½®é¡¶æ ‡è®°
                        const pinnedMarker = notification.pinned ? '<span class="pinned-marker">ğŸ“Œ</span>' : '';
                        
                        notificationsHTML += `
                            <div class="notification-item" data-id="${notification.id}">
                                <div class="notification-header">
                                    <h3>${notification.title || 'æ— æ ‡é¢˜'} ${pinnedMarker}</h3>
                                </div>
                                <div class="notification-content">
                                    ${contentHTML}
                                    ${attachmentHTML}
                                    <div class="notification-footer">
                                        <div class="notification-time">${timeStr}</div>
                                        ${linkHTML}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    notificationsHTML += '</div>';
                    
                    // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
                    modalBody.innerHTML = notificationsHTML;
                    
                    // ä¸ºæŸ¥çœ‹è¯¦æƒ…é“¾æ¥æ·»åŠ äº‹ä»¶å¤„ç†
                    const viewDetailLinks = modalBody.querySelectorAll('.view-detail-link');
                    viewDetailLinks.forEach(link => {
                        link.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const notificationId = parseInt(this.getAttribute('data-notification-id'));
                            const notification = sortedNotifications.find(n => n.id === notificationId);
                            if (notification) {
                                showNotificationDetail(notification);
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('è·å–é€šçŸ¥æ•°æ®å¤±è´¥:', error);
                    modalBody.innerHTML = '<p>è·å–é€šçŸ¥æ•°æ®å¤±è´¥</p>';
                });
        }
        
        // æ˜¾ç¤ºé€šçŸ¥è¯¦æƒ…ï¼ˆä»mobile.jså¤åˆ¶ï¼‰
        function showNotificationDetail(notification) {
            const detailModal = document.getElementById('notification-detail-modal');
            const body = document.getElementById('notification-detail-body');
            
            // éšè—æ‰€æœ‰å…¶ä»–æ¨¡æ€æ¡†
            const allModals = document.querySelectorAll('.modal');
            allModals.forEach(modal => {
                if (modal !== detailModal) {
                    modal.classList.remove('active');
                }
            });
            
            // æ„å»ºé€šçŸ¥è¯¦æƒ…HTML
            const timeStr = notification.time || '';
            
            // å¤„ç†å†…å®¹æ˜¾ç¤ºï¼Œè‡ªåŠ¨è¯†åˆ«å†…å®¹ä¸­çš„é“¾æ¥
            let contentStr = notification.content || '';
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¯†åˆ«URLå¹¶è½¬æ¢ä¸ºå¯ç‚¹å‡»é“¾æ¥ï¼Œæ”¯æŒä»¥å³æ‹¬å·ç»“å°¾çš„URL
             const urlRegex = /(https?:\/\/[^\s\)]+)\)?/g;
             contentStr = contentStr.replace(urlRegex, function(match, url) {
                 // å¦‚æœURLä»¥å³æ‹¬å·ç»“å°¾ï¼Œåˆ™ç§»é™¤å³æ‹¬å·
                 if (match.endsWith(')') && !url.endsWith(')')) {
                     return `<a href="${url}" target="_blank">${url}</a>)`;
                 } else {
                     return `<a href="${url}" target="_blank">${url}</a>`;
                 }
             });
            
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ¢è¡Œæ ‡ç­¾
            contentStr = contentStr.replace(/\n/g, '<br>');
            
            let linkHTML = '';
            if (notification.link) {
                linkHTML = `
                    <div class="notification-detail-link">
                        <h4>é“¾æ¥</h4>
                        <a href="${notification.link}" target="_blank">ç‚¹å‡»è®¿é—®</a>
                    </div>
                `;
            }
            
            let attachmentHTML = '';
            if (notification.attachment) {
                attachmentHTML = `
                    <div class="notification-detail-attachment">
                        <h4>é™„ä»¶</h4>
                        <p>${notification.attachment}</p>
                    </div>
                `;
            }
            
            body.innerHTML = `
                <div class="notification-detail">
                    <div class="notification-detail-header">
                        <h3>${notification.title || 'æ— æ ‡é¢˜'}</h3>
                        <div class="notification-detail-time">${timeStr}</div>
                    </div>
                    <div class="notification-detail-content">
                        <h4>å†…å®¹</h4>
                        <p>${contentStr}</p>
                    </div>
                    ${attachmentHTML}
                    ${linkHTML}
                </div>
            `;
            
            detailModal.classList.add('active');
            document.getElementById('modal-container').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        // æ›´æ–°æ”¶è—å¤¹æ¨¡æ€æ¡†å†…å®¹ï¼ˆä»mobile.jså¤åˆ¶ï¼‰
        function updateFavoritesModal() {
            const favoritesModal = document.getElementById('favorites-modal');
            const modalBody = favoritesModal.querySelector('.modal-body');
            
            // ä»localStorageè·å–æ”¶è—å¤¹æ•°æ®
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            
            if (favorites.length === 0) {
                modalBody.innerHTML = '<p>æš‚æ— æ”¶è—ç½‘ç«™</p>';
                return;
            }
            
            // æ„å»ºæ”¶è—å¤¹åˆ—è¡¨HTML
            let favoritesHTML = '<div class="favorites-list">';
            favorites.forEach((favorite, index) => {
                favoritesHTML += `
                    <div class="favorite-item" data-url="${favorite.url}">
                        <div class="favorite-item-content">
                            <h3>${favorite.name}</h3>
                            <p>${favorite.url}</p>
                        </div>
                        <button class="unfavorite-btn" data-index="${index}">&times;</button>
                    </div>
                `;
            });
            favoritesHTML += '</div>';
            
            // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
            modalBody.innerHTML = favoritesHTML;
            
            // ä¸ºæ”¶è—é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆæ‰“å¼€ç½‘ç«™ï¼‰
            const favoriteItems = modalBody.querySelectorAll('.favorite-item');
            favoriteItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯å–æ¶ˆæ”¶è—æŒ‰é’®ï¼Œåˆ™ä¸æ‰“å¼€ç½‘ç«™
                    if (e.target.classList.contains('unfavorite-btn')) {
                        return;
                    }
                    
                    const url = this.getAttribute('data-url');
                    if (url) {
                        window.open(url, '_blank');
                    }
                });
            });
            
            // ä¸ºå–æ¶ˆæ”¶è—æŒ‰é’®æ·»åŠ äº‹ä»¶
            const unfavoriteButtons = modalBody.querySelectorAll('.unfavorite-btn');
            unfavoriteButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.getAttribute('data-index'));
                    removeFavorite(index);
                    updateFavoritesModal(); // é‡æ–°åŠ è½½æ”¶è—å¤¹
                });
            });
        }
        
        // ç§»é™¤æ”¶è—ï¼ˆä»mobile.jså¤åˆ¶ï¼‰
        function removeFavorite(index) {
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            favorites.splice(index, 1);
            localStorage.setItem('favorites', JSON.stringify(favorites));
        }
        
        // æ›´æ–°å†å²è®°å½•æ¨¡æ€æ¡†å†…å®¹ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        function updateHistoryModal() {
            const historyModal = document.getElementById('history-modal');
            const modalBody = historyModal.querySelector('.modal-body');
            
            // ä»localStorageè·å–å†å²è®°å½•æ•°æ®
            const history = JSON.parse(localStorage.getItem('history') || '[]');
            
            if (history.length === 0) {
                modalBody.innerHTML = '<p>æš‚æ— å†å²è®°å½•</p>';
                return;
            }
            
            // åªæ˜¾ç¤ºæœ€è¿‘10æ¡è®°å½•
            const recentHistory = history.slice(-10).reverse();
            
            // æ„å»ºå†å²è®°å½•åˆ—è¡¨HTML
            let historyHTML = '<div class="history-list">';
            recentHistory.forEach((item, index) => {
                historyHTML += `
                    <div class="history-item" data-url="${item.url}">
                        <div class="history-item-content">
                            <h3>${item.name}</h3>
                            <p>${item.url}</p>
                            <div class="history-time">${item.time}</div>
                        </div>
                    </div>
                `;
            });
            historyHTML += '</div>';
            
            // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
            modalBody.innerHTML = historyHTML;
            
            // ä¸ºå†å²è®°å½•é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆæ‰“å¼€ç½‘ç«™ï¼‰
            const historyItems = modalBody.querySelectorAll('.history-item');
            historyItems.forEach(item => {
                item.addEventListener('click', function() {
                    const url = this.getAttribute('data-url');
                    if (url) {
                        window.open(url, '_blank');
                    }
                });
            });
        }
        
        // è®¡ç®—å½“å‰å‘¨æ•°
        function calculateCurrentWeek() {
            // ç¬¬ä¸€å‘¨çš„å‘¨ä¸€æ—¥æœŸï¼š2025å¹´9æœˆ8æ—¥
            const firstWeekDate = new Date('2025-09-08T00:00:00');
            
            // è·å–å½“å‰æ—¥æœŸ
            const currentDate = new Date();
            
            // è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„æ¯«ç§’å·®
            const timeDiff = currentDate.getTime() - firstWeekDate.getTime();
            
            // è®¡ç®—ç›¸å·®çš„å‘¨æ•°ï¼ˆæ¯«ç§’è½¬å¤©æ•°å†é™¤ä»¥7ï¼‰
            const daysDiff = timeDiff / (1000 * 3600 * 24);
            const weeksDiff = Math.floor(daysDiff / 7);
            
            // è®¡ç®—å½“å‰å‘¨æ•°ï¼ˆç¬¬ä¸€å‘¨å¼€å§‹ï¼‰
            let currentWeek = 1 + weeksDiff;
            
            // ç¡®ä¿å‘¨æ•°åœ¨åˆç†èŒƒå›´å†…ï¼ˆ1-16å‘¨ï¼‰
            if (currentWeek < 1) currentWeek = 1;
            if (currentWeek > 16) currentWeek = 16;
            
            return currentWeek;
        }
        
        // æ›´æ–°å½“å‰æ—¥æœŸæ—¶é—´æ˜¾ç¤º
        function updateDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            // æ˜ŸæœŸå‡ 
            const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            const weekday = weekdays[now.getDay()];
            
            // æ ¼å¼åŒ–æ˜¾ç¤º
            const dateTimeStr = `${year}å¹´${month}æœˆ${day}æ—¥ ${weekday}`;
            
            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            const dateTimeElement = document.getElementById('currentDateTime');
            if (dateTimeElement) {
                dateTimeElement.textContent = dateTimeStr;
            }
            
            // è®¡ç®—å¹¶æ›´æ–°å½“å‰å‘¨æ•°æ˜¾ç¤º
            const currentWeek = calculateCurrentWeek();
            const currentWeekElement = document.getElementById('currentWeekDisplay');
            if (currentWeekElement) {
                currentWeekElement.textContent = `ç¬¬${currentWeek}å‘¨`;
            }
            
            // æ›´æ–°å®æ—¶è¯¾ç¨‹ä¿¡æ¯
            updateRealtimeCourseInfo(now);
        }
        
        // èŠ‚æ¬¡æ—¶é—´å®šä¹‰
        const classPeriods = [
            { name: "ç¬¬ä¸€èŠ‚è¯¾", start: "08:00", end: "08:50" },
            { name: "ç¬¬äºŒèŠ‚è¯¾", start: "09:00", end: "09:50" },
            { name: "ç¬¬ä¸‰èŠ‚è¯¾", start: "10:10", end: "11:00" },
            { name: "ç¬¬å››èŠ‚è¯¾", start: "11:10", end: "12:00" },
            { name: "ç¬¬äº”èŠ‚è¯¾", start: "14:30", end: "15:20" },
            { name: "ç¬¬å…­èŠ‚è¯¾", start: "15:30", end: "16:20" },
            { name: "ç¬¬ä¸ƒèŠ‚è¯¾", start: "16:40", end: "17:30" },
            { name: "ç¬¬å…«èŠ‚è¯¾", start: "17:40", end: "18:30" },
            { name: "ç¬¬ä¹èŠ‚è¯¾", start: "19:40", end: "20:30" },
            { name: "ç¬¬åèŠ‚è¯¾", start: "20:40", end: "21:30" }
        ];
        
        // è·å–å½“å‰æ—¶é—´æ®µ
        function getCurrentPeriod(now) {
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            for (let i = 0; i < classPeriods.length; i++) {
                const period = classPeriods[i];
                // æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åœ¨èŠ‚æ¬¡æ—¶é—´èŒƒå›´å†…
                if (currentTime >= period.start && currentTime <= period.end) {
                    return i;
                }
            }
            
            return -1; // ä¸åœ¨ä»»ä½•èŠ‚æ¬¡æ—¶é—´å†…
        }
        
        // è·å–å½“å‰æ—¶é—´æ®µåç§°
        function getCurrentPeriodName(now) {
            const periodIndex = getCurrentPeriod(now);
            return periodIndex >= 0 ? classPeriods[periodIndex].name : "éè¯¾ç¨‹æ—¶é—´";
        }
        
        // è·å–ä¸‹ä¸€ä¸ªèŠ‚æ¬¡
        // è·å–ä¸‹ä¸€ä¸ªèŠ‚æ¬¡ï¼ˆæŸ¥æ‰¾ä»»æ„æ—¶é—´çš„ä¸‹ä¸€èŠ‚è¯¾ï¼‰
        function getNextPeriod(now, currentWeek, timetableDayIndex, user = currentSelectedUser) {
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            // é¦–å…ˆæ£€æŸ¥ä»Šå¤©å‰©ä½™çš„æ—¶é—´
            for (let i = 0; i < classPeriods.length; i++) {
                const period = classPeriods[i];
                // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¼€å§‹æ—¶é—´æ™šäºå½“å‰æ—¶é—´çš„èŠ‚æ¬¡
                if (period.start > currentTime) {
                    // æ£€æŸ¥ä»Šå¤©è¿™ä¸ªèŠ‚æ¬¡æ˜¯å¦æœ‰è¯¾
                    const course = timetableData[user] && timetableData[user][currentWeek] && timetableData[user][currentWeek][i] 
                        ? timetableData[user][currentWeek][i][timetableDayIndex] : null;
                    if (course) {
                        return { periodIndex: i, dayOffset: 0 };
                    }
                }
            }
            
            // å¦‚æœä»Šå¤©æ²¡æœ‰å‰©ä½™è¯¾ç¨‹ï¼ŒæŸ¥æ‰¾æœªæ¥å‡ å¤©çš„è¯¾ç¨‹
            const dayOfWeek = now.getDay();
            // ä»æ˜å¤©å¼€å§‹æ£€æŸ¥ï¼Œæœ€å¤šæ£€æŸ¥7å¤©
            for (let dayOffset = 1; dayOffset <= 7; dayOffset++) {
                const futureDate = new Date(now);
                futureDate.setDate(now.getDate() + dayOffset);
                
                // è®¡ç®—æœªæ¥æ—¥æœŸçš„æ˜ŸæœŸå‡ å’Œè¯¾è¡¨ç´¢å¼•
                const futureDayOfWeek = futureDate.getDay();
                const futureTimetableDayIndex = futureDayOfWeek === 0 ? 6 : futureDayOfWeek - 1;
                
                // è®¡ç®—æœªæ¥æ—¥æœŸçš„å‘¨æ•°
                const futureWeek = calculateCurrentWeekForDate(futureDate);
                
                // æ£€æŸ¥è¿™ä¸€å¤©çš„æ¯ä¸€èŠ‚è¯¾
                for (let i = 0; i < classPeriods.length; i++) {
                    const course = timetableData[user] && timetableData[user][futureWeek] && timetableData[user][futureWeek][i] 
                        ? timetableData[user][futureWeek][i][futureTimetableDayIndex] : null;
                    if (course) {
                        return { periodIndex: i, dayOffset: dayOffset };
                    }
                }
            }
            
            return { periodIndex: -1, dayOffset: 0 }; // æ²¡æœ‰æ‰¾åˆ°ä¸‹ä¸€èŠ‚è¯¾
        }
        
        // è®¡ç®—æŒ‡å®šæ—¥æœŸçš„å‘¨æ•°
        function calculateCurrentWeekForDate(date) {
            // è·å–ç¬¬ä¸€å‘¨çš„å¼€å§‹æ—¥æœŸï¼ˆ2025å¹´9æœˆ8æ—¥ï¼Œæ˜ŸæœŸä¸€ï¼‰
            const firstWeekDate = new Date('2025-09-08T00:00:00');
            
            // è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„æ¯«ç§’å·®
            const timeDiff = date.getTime() - firstWeekDate.getTime();
            
            // è®¡ç®—ç›¸å·®çš„å‘¨æ•°ï¼ˆæ¯«ç§’è½¬å¤©æ•°å†é™¤ä»¥7ï¼‰
            const daysDiff = timeDiff / (1000 * 3600 * 24);
            const weeksDiff = Math.floor(daysDiff / 7);
            
            // è®¡ç®—å‘¨æ•°ï¼ˆç¬¬ä¸€å‘¨å¼€å§‹ï¼‰
            let week = 1 + weeksDiff;
            
            // ç¡®ä¿å‘¨æ•°åœ¨åˆç†èŒƒå›´å†…ï¼ˆ1-16å‘¨ï¼‰
            if (week < 1) week = 1;
            if (week > 16) week = 16;
            
            return week;
        }
        
        // æ›´æ–°å®æ—¶è¯¾ç¨‹ä¿¡æ¯
        function updateRealtimeCourseInfo(now) {
            // è·å–å®æ—¶ä¿¡æ¯å®¹å™¨
            const realtimeContainer = document.getElementById('realtime-container');
            
            // è·å–å½“å‰æ˜ŸæœŸå‡  (0-6, 0ä¸ºæ˜ŸæœŸæ—¥)
            const dayOfWeek = now.getDay();
            // è½¬æ¢ä¸ºè¯¾è¡¨ä¸­çš„åˆ—ç´¢å¼• (0-6, 0ä¸ºæ˜ŸæœŸä¸€)
            const timetableDayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            
            // è·å–å½“å‰å‘¨æ•°
            const currentWeek = calculateCurrentWeek();
            
            // è·å–å½“å‰èŠ‚æ¬¡
            const currentPeriodIndex = getCurrentPeriod(now);
            
            // å®šä¹‰å­¦ç”Ÿå’Œå¯¹åº”çš„è¯¾è¡¨æ–‡ä»¶
            const students = {
                'H': 'huxinyue.txt',
                'X': 'X.txt',
                'Y': 'yangxin.txt'
            };
            
            // ä¸ºæ¯ä¸ªå­¦ç”Ÿæ›´æ–°å½“å‰è¯¾ç¨‹ä¿¡æ¯å’Œä¸‹ä¸€è¯¾ç¨‹ä¿¡æ¯
            for (const [student, timetableFile] of Object.entries(students)) {
                // è·å–ä¸‹ä¸€ä¸ªèŠ‚æ¬¡ï¼ˆä¸ºæ¯ä¸ªç”¨æˆ·å•ç‹¬è®¡ç®—ï¼‰
                const nextPeriodInfo = getNextPeriod(now, currentWeek, timetableDayIndex, student);
                const nextPeriodIndex = nextPeriodInfo.periodIndex;
                const nextDayOffset = nextPeriodInfo.dayOffset;
                
                // æ›´æ–°å½“å‰è¯¾ç¨‹ä¿¡æ¯
                updateCurrentCourseInfo(student, currentWeek, currentPeriodIndex, timetableDayIndex);
                
                // æ›´æ–°ä¸‹ä¸€è¯¾ç¨‹ä¿¡æ¯
                updateNextCourseInfo(student, currentWeek, nextPeriodIndex, timetableDayIndex, nextDayOffset);
            }
            
            // æ ¹æ®æ»‘åŠ¨å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºå®æ—¶ä¿¡æ¯å®¹å™¨
            const controlsToggle = document.getElementById('controlsToggle');
            if (!controlsToggle.checked) {
                realtimeContainer.style.display = 'block';
            }
        }
        
        // æ›´æ–°å½“å‰è¯¾ç¨‹ä¿¡æ¯
        function updateCurrentCourseInfo(student, currentWeek, currentPeriodIndex, timetableDayIndex) {
            const currentCell = document.getElementById(`current-${student}`);
            
            if (currentPeriodIndex >= 0) {
                // è·å–å½“å‰èŠ‚æ¬¡è¯¾ç¨‹
                const currentCourse = timetableData[student] && timetableData[student][currentWeek] && timetableData[student][currentWeek][currentPeriodIndex] 
                    ? timetableData[student][currentWeek][currentPeriodIndex][timetableDayIndex] : null;
                
                if (currentCourse) {
                    currentCell.innerHTML = `
                        <div class="course-title">${currentCourse.title || 'æ— è¯¾ç¨‹'}</div>
                        <div class="course-time">${classPeriods[currentPeriodIndex].start}-${classPeriods[currentPeriodIndex].end}</div>
                        <div class="course-classroom">${currentCourse.classroom || 'æ— æ•™å®¤ä¿¡æ¯'}</div>
                    `;
                } else {
                    currentCell.innerHTML = '<div class="no-course">æ— è¯¾ç¨‹</div>';
                }
            } else {
                currentCell.innerHTML = '<div class="no-course">éè¯¾ç¨‹æ—¶é—´</div>';
            }
        }
        
        // æ›´æ–°ä¸‹ä¸€ä¸ªè¯¾ç¨‹ä¿¡æ¯
        function updateNextCourseInfo(student, currentWeek, nextPeriodIndex, timetableDayIndex, nextDayOffset) {
            const nextCell = document.getElementById(`next-${student}`);
            
            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!nextCell) {
                console.error(`Element with ID 'next-${student}' not found`);
                return;
            }
            
            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            nextCell.innerHTML = '';
            
            // å¦‚æœæ²¡æœ‰ä¸‹ä¸€èŠ‚è¯¾ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (nextPeriodIndex === -1) {
                nextCell.innerHTML = '<div class="no-course">æš‚æ— åç»­è¯¾ç¨‹</div>';
                return;
            }
            
            // è®¡ç®—å®é™…çš„æ—¥æœŸ
            const now = new Date();
            const nextDate = new Date(now);
            nextDate.setDate(now.getDate() + nextDayOffset);
            
            // è·å–æ˜ŸæœŸå‡ çš„æ–‡æœ¬
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const dayText = weekdays[nextDate.getDay()];
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            const month = nextDate.getMonth() + 1;
            const date = nextDate.getDate();
            const dateText = `${month}æœˆ${date}æ—¥`;
            
            // è·å–è¯¾ç¨‹ä¿¡æ¯
            let nextCourse = null;
            let nextWeek = currentWeek;
            
            if (nextDayOffset === 0) {
                // ä»Šå¤©çš„è¯¾ç¨‹
                nextCourse = timetableData[student] && timetableData[student][currentWeek] && timetableData[student][currentWeek][nextPeriodIndex] 
                    ? timetableData[student][currentWeek][nextPeriodIndex][timetableDayIndex] : null;
            } else {
                // æœªæ¥æ—¥æœŸçš„è¯¾ç¨‹
                nextWeek = calculateCurrentWeekForDate(nextDate);
                const futureTimetableDayIndex = nextDate.getDay() === 0 ? 6 : nextDate.getDay() - 1;
                nextCourse = timetableData[student] && timetableData[student][nextWeek] && timetableData[student][nextWeek][nextPeriodIndex] 
                    ? timetableData[student][nextWeek][nextPeriodIndex][futureTimetableDayIndex] : null;
            }
            
            if (nextCourse) {
                // æ˜¾ç¤ºè¯¾ç¨‹ä¿¡æ¯
                const periodText = classPeriods[nextPeriodIndex].name;
                const courseName = nextCourse.title || 'æ— è¯¾ç¨‹';
                const location = nextCourse.classroom || 'æ— æ•™å®¤ä¿¡æ¯';
                const periodTime = `${classPeriods[nextPeriodIndex].start}-${classPeriods[nextPeriodIndex].end}`;
                
                // æ„é€ æ–°çš„æ—¶é—´æ˜¾ç¤ºæ ¼å¼ï¼šç¬¬xå‘¨-å‘¨y æ¢è¡Œ èŠ‚æ¬¡å¯¹åº”çš„æ—¶é—´æ®µ
                const newPeriodText = `ç¬¬${nextWeek}å‘¨-${dayText}`;
                
                // å¦‚æœæ˜¯æœªæ¥æ—¥æœŸï¼Œæ˜¾ç¤ºæ—¥æœŸä¿¡æ¯
                if (nextDayOffset === 0) {
                    nextCell.innerHTML = `
                        <div class="course-title">${courseName}</div>
                        <div class="course-time">${newPeriodText}<br>${periodTime}</div>
                        <div class="course-classroom">${location}</div>
                    `;
                } else {
                    nextCell.innerHTML = `
                        <div class="course-title">${courseName}</div>
                        <div class="course-time">${newPeriodText}<br>${periodTime}</div>
                        <div class="course-classroom">${location}</div>
                    `;
                }
            } else {
                nextCell.innerHTML = '<div class="no-course">æš‚æ— åç»­è¯¾ç¨‹</div>';
            }
        }
        
        
    </script>
</body>
</html>